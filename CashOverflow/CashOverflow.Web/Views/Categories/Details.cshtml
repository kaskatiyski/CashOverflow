@model CashOverflow.Web.ViewModels.Category.DetailsCategoryViewModel

@using CashOverflow.Models.Enum

@{
    ViewData["Title"] = "Details";
}

<style>

    .page-title-wrapper {

    }

    .page-title {

    }

    .page-maintitle {
        font-size: 1.8rem;
        line-height: 1;
    }

    .page-subtitle {
        font-size: 1rem;
    }

    .page-title-actions {

    }

        .page-title-actions .btn {
            /*rgb(143, 95, 218)*/
            background: var(--accent-color);
            color: white;
            font-size: 0.75rem;
        }

</style>

<div class="page-title-wrapper row align-items-center">
    <div class="page-title col">
        <div class="page-maintitle">
            @Model.Name
        </div>
        <div class="page-subtitle">
            Categories
        </div>
    </div>
    <div class="page-title-actions col-auto">
        @*<button class="btn btn-sm btn-primary text-light">
            @Html.ActionLink("Edit", "Edit", new
            {
                id = Model.Id,
            })
        </button>*@
        <a role="button" href="/Categories/Edit/@Model.Id" class="btn btn-sm">Edit</a>
        <a role="button" asp-action="All" class="btn btn-sm">List</a>
        <button class="btn btn-sm">Filters</button>
    </div>
</div>

@*<div>
    @Html.ActionLink("Edit", "Edit", new
    {
        id = Model.Id
    }) |
    <a asp-action="All">Back to List</a>
</div>*@

@await Html.PartialAsync("_CategoryDeleteModel")

<div class="row">
    <div class="col-xl-3 col-md-6">
        <div class="custom-card">
            <div class="custom-card-header cursor-unset">
                <div class="custom-card-header-title">
                    <div class="custom-card-header-subtitle">
                        transactions
                    </div>
                    <div class="custom-card-header-maintitle">
                        <span id="count">@Model.Transactions.Select(x => x.Count()).Sum()</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="custom-card">
            <div class="custom-card-header cursor-unset">
                <div class="custom-card-header-title">
                    <div class="custom-card-header-subtitle">
                        amount
                    </div>
                    <div class="custom-card-header-maintitle">
                        <span id="sum"></span> BGN
                        @*@Model.Transactions.Select(x => x.Select(y => y.Ammount).Sum()).Sum()*@
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="custom-card">
            <div class="custom-card-header cursor-unset">
                <div class="custom-card-header-title">
                    <div class="custom-card-header-subtitle">
                        average
                    </div>
                    <div class="custom-card-header-maintitle">
                        <span id="avg"></span> BGN per month
                    </div>
                </div>
            </div>
        </div>
    </div>
    <style>

        .progress-wrapper {
            width: 100%;
            font-size: 0.9rem;
        }

        .progress-title-wrapper {

        }

        .progress-title-text {

        }

        .progress-title-value {
            float: right;
        }

        .progress-bar-wrapper {
            width: 100%;
            height: 7px;
            background: rgb(246, 245, 246);
            border-radius: 5px;
            margin-top: 5px;
        }

        .progress-bar {
            height: 100%;
            width: 37.5543%;
            background: #c45850;
            border-radius: 5px;
        }
    </style>
    <div class="col-xl-3 col-md-6">
        <div class="custom-card">
            <div class="custom-card-header cursor-unset">
                <div class="custom-card-header-title">
                    <div class="custom-card-header-subtitle">
                        budget
                    </div>
                    @*<div class="custom-card-header-maintitle">

                    </div>*@
                </div>
            </div>
            <div class="custom-card-body">
                <div class="progress-wrapper">
                    <div class="progress-title-wrapper">
                        Bills
                        <span class="progress-title-value">215.59 / 600</span>
                    </div>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar"></div>
                    </div>
                </div>
                @*You haven't set a budget for this category yet.
                <br />
                To set a budget <a href="">click here.</a>*@
            </div>
        </div>
    </div>
</div>

<div>

    @*<hr />*@
    <div class="row">
        <dt class="col-sm-2 col-12">
            @Html.DisplayNameFor(model => model.Type)
        </dt>
        <dd class="col-sm-10 col-12">
            @Html.DisplayFor(model => model.Type)
        </dd>
        @*<dt class="col-sm-2 col-12">
                @Html.DisplayNameFor(model => model.ImagePath)
            </dt>
            <dd class="col-sm-10 col-12">
                @Html.DisplayFor(model => model.ImagePath)
            </dd>*@

        <dd>

        </dd>
    </div>
</div>

<div>
    <canvas id="chartTransactions" width="400" height="400"></canvas>
</div>


@await Html.PartialAsync("_TransactionsListPartial", Model.Transactions)



<script>
    let transactions = { };

    @{
        var startDate = DateTime.Parse(Model.Transactions.FirstOrDefault().Key).AddMonths(-1);
        var currentDate = startDate;
        var endDate = DateTime.Parse(Model.Transactions.LastOrDefault().Key).AddMonths(1);

        while (currentDate <= endDate)
        {
            var key = currentDate.ToString("MMMM yyyy");
            var group = Model.Transactions.FirstOrDefault(g => g.Key == key);
            decimal sum;

            if (group != null)
            {
                sum = group.Sum(x => x.Ammount);
            }
            else
            {
                sum = 0;
            }

            @:transactions['@key'] = @sum;

            currentDate = currentDate.AddMonths(1);
                }
                }



    let chartOptions = {
    type: 'line',
    plugins: [ChartDataLabels],
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            datalabels: {
                align: 'end',
                anchor: 'end',
                //clip: true,
                backgroundColor: function(context) {
                    return context.dataset.borderColor;
                },
                borderRadius: 4,
                color: 'white',
                font: {
                    weight: 'bold'
                },
                formatter: Math.round
            },
        },
        tooltips: {
            mode: 'index',
            intersect: false,
            backgroundColor: "rgb(255,255,255)",
            bodyFontColor: "#858796",
            titleFontColor: "#858796",
            borderColor: '#dddfeb',
            borderWidth: 1,
            xPadding: 15,
            yPadding: 15,
            displayColors: false,
            caretPadding: 10,
        },
        legend: {
            display: false
        },
        title: {
            display: true,
            text: '@Model.Name'
        },
        hover: {
            mode: 'nearest',
            intersect: true
        },
        pan: {
            enabled: true,
            speed: 2,
            threshold: 100,
            mode: 'x'
        },
        zoom: {
            enabled: true,
            sensitivity: 2,
            mode: 'x',
        },
    },
}

let data = Object.values(transactions);
let keys = Object.keys(transactions);

$(document).ready(function() {
    let sum = data.reduce(function(a, b) {
        return a + b;
    });
    let avg = sum / (data.length - 2)

    $("#sum").text(sum.toFixed(2));
    $("#avg").text(avg.toFixed(2));
});

let transactionsChartElement = $('#chartTransactions');
let transactionsChart = new Chart(transactionsChartElement, {
    data: {
        labels: keys,
        datasets: [{
            label: '@Model.Name',
            data: data,
            fill: false,
            borderColor: '#@(Model.Type == CategoryType.Expense? "c45850" : "2a9d8f")',
            lineTension: 0,
            //lineTension: 100,
        }],
    },
    ...chartOptions
});


</script>
